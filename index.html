<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Files On Web</title>
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/fileonweb.js"></script>
    <link rel="stylesheet" href="/css/main.css">
</head>
<!-- {{/*https://www.runoob.com/w3cnote/flex-grammar.html*/}} -->
<style>
    .header-path {
        text-align: left;
        overflow: hidden;
        left: 150px;
        position: fixed;
        margin-top: 11px;
        font-size: 15px;
        display: flex;
    }
</style>

<body onscroll="boardScroll(this);">
    <header class="topbar">
        <div class="logo">FileOnWeb</div>
        <div class="header-path">
            <div id="global-working-path" style="display:none;">{{ . }}</div>
            <div class="pwd_cell"><a href="/files/">HOME</a></div>
            <div class="pwd_cell"><a href="/files/">HOME</a></div>
        </div>
        <div id="debug-output-table"></div>
    </header>
    <section class="main-section">
        <div id="display-board" class="item_row">
        </div>
        <script>
            var WORKING_PATH = "/files" + $("#global-working-path").text();
            $(document).ready(function () {
                $.getJSON(WORKING_PATH, {
                    "requestfor": "data"
                }, function (data, textStatus, jqXHR) {
                    WORK_DATA_ITERATOR.setList(data);
                    while ($(document).height() < window.innerHeight + 200) {
                        if (!displayItems(10)) {
                            break;
                        }
                    }
                });
            });

            function boardScroll(self) {
                if ($(document).height() - $(document).scrollTop() - window.innerHeight < 200) {
                    displayItems(20);
                }
            }

            function displayItems(count) {
                for (var i = 0; i < count; i++) {
                    var itemPack = WORK_DATA_ITERATOR.next();
                    if (itemPack.index < 0) {
                        $('#end-of-board').text("ｍ(o・ω・o)ｍ");
                        return false;
                    }
                    addItem(itemPack.index, itemPack.data);
                }
                return true;
            }

            function imageComplete(self) {
                $(self).css("background-color", "transparent");
            }

            function addItem(index, item) {
                var imgp = "";
                var width = 120;
                if (item.IsImg) {
                    imgp =
                        `<img src="${item.Path}" alt="${item.Name}" title="${item.Name}" style="background-color:${randomColor()};width:${item.Width}px;height:${item.Height}px;" onload="imageComplete(this);">`;
                    width = item.Width;
                } else {
                    imgp =
                        `<img src="${item.Icon}" alt="${item.Name}" title="${item.Name}" style="background-color:${randomColor()};width:120px;height:120px;" onload="imageComplete(this);">`;
                }

                $('#display-board').append(
                    `<div class="item_cell" id="item_index_${index}">
                        <a href="${item.Path}">
                        ${imgp}
                        <div class="item_name" style="width:${width}px;"><p>${item.Name}</p></div>
                        </a>
                    </div>`
                );
            }
        </script>
        <script>
            // function optimizePWD() {
            //     var pwd = $('#global-working-path').text().split('/');
            //     $('#global-working-path').css('display', 'none');
            //     alert(pwd);
            // }
        </script>
    </section>
    <div id="end-of-board" class="end-of-board"></div>
</body>

</html>